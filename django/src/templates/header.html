{% load static %}
{% block content %}
<header>
	<!-- <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Chivo:ital,wght@0,100..900;1,100..900&family=Lora:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet"> -->
	<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="{% static 'css/header.css' %}">
	<nav>
		<ul>
			<li><button class="nav-button" data-url="{% url 'home' %}">Home</button></li>
			<li id="game-buttons"></li>
			<li id="auth-buttons"></li>
			<!-- <li><button id="friends-button">Amis</button></li> -->
		</ul>
	</nav>

	<div id="pong-modal" class="modal">
		<div class="modal-content">
			<h2>Games</h2>
			<span class="close-modal">&times;</span>
			<div class="horizontal-line"></div>
			<h3>Pong Mode</h3>
			<button class="modal-button" data-url="{% url 'local' %}">Local</button>
			<button class="modal-button" data-url="{% url 'vsBot' %}">IA</button>
			<button class="modal-button" data-url="{% url 'match' %}">Match</button>
			<button class="modal-button" data-url="{% url 'tournament' %}">Tournament</button>
			<div class="horizontal-line"></div>
			<h3>Other Game</h3>
			<button class="modal-button" data-url="{% url 'snake' %}">Snake</button>
		</div>
	</div>

	<div id="friends-modal" class="modal">
		<div class="modal-content">
			{% csrf_token %}
			<div class="friends-section">
				<h2>Friends List</h2>
				<span class="close-friends-modal">&times;</span>
				<div class="horizontal-line"></div>
				<div id="add-friend-form">
					<input type="text" id="friend-username" placeholder="Add Friend" />
					<button id="add-friend-button">+</button>
					<div id="error-message" class="error-message"></div>
				</div>
				<div class="horizontal-line"></div>
				<div class="invitations-section">
					<div id="game-invitations-container">
						<p>Chargement des invitations...</p>
					</div>
				</div>
				<div id="friends-list">
					<!-- La liste sera remplie dynamiquement via JavaScript -->
				</div>
			</div>
		</div>
	</div>


	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const pongModal = document.getElementById('pong-modal');
			const closeModalButton = document.querySelector('.close-modal');

			closeModalButton.addEventListener('click', function () {
				pongModal.style.display = 'none';
			});
			window.addEventListener('click', function (event) {
				if (event.target === pongModal) {
					pongModal.style.display = 'none';
				}
			});
			const modalButtons = document.querySelectorAll('.modal-button');
			modalButtons.forEach(button => {
				button.addEventListener('click', function () {
					const url = button.getAttribute('data-url');
					if (url) {
						window.location.href = url;
					}
				});
			});

			// Friends Modal
			const friendsModal = document.getElementById('friends-modal');
			const friendsButton = document.getElementById('friends-button');
			const closeFriendsModal = document.querySelector('.close-friends-modal');
			const friendsList = document.getElementById('friends-list');
			const addFriendButton = document.getElementById('add-friend-button');
			const friendUsernameInput = document.getElementById('friend-username');

			friendsButton.addEventListener('click', function () {
				fetchFriends();
				friendsModal.style.display = 'block';
			});

			closeFriendsModal.addEventListener('click', function () {
				friendsModal.style.display = 'none';
			});

			window.addEventListener('click', function (event) {
				if (event.target === friendsModal) {
					friendsModal.style.display = 'none';
				}
			});

			addFriendButton.addEventListener('click', function () {
				const username = friendUsernameInput.value.trim();
				if (username) {
					addFriend(username);
					friendUsernameInput.value = ''; // Réinitialiser l'input
				}
			});

			function fetchFriends() {
				fetch('/api/friends/', {
					method: 'GET',
					headers: {
						'Content-Type': 'application/json',
					},
				})
				.then(response => {
					if (!response.ok) {
						if (response.status === 401) {
							throw new Error('Non authentifié - veuillez vous reconnecter');
						}
						throw new Error('Erreur lors du chargement des amis');
					}
					return response.json();
				})
				.then(data => {
					if (data.friends && data.friends.length > 0) {
						friendsList.innerHTML = data.friends.map(friend => `
							<div class="friend-item">
								<div class="friend-avatar-container">
									${friend.profile_picture ?
										`<img src="${friend.profile_picture}" alt="${friend.username}" class="friend-avatar">` :
										`<div class="friend-avatar default-avatar">${(friend.nickname || friend.username).charAt(0).toUpperCase()}</div>`
									}
									<div class="status-indicator ${friend.is_online ? 'status-online' : 'status-offline'}"></div>
								</div>
								<div class="friend-info">
									<div class="friend-name">${friend.nickname || friend.username}</div>
									<div class="friend-status">${friend.is_online ? 'En ligne' : 'Hors ligne'}</div>
								</div>
							</div>
						`).join('');

						// Ajoutez ici les event listeners pour les boutons d'action si nécessaire
					} else {
						friendsList.innerHTML = '<p>Vous n\'avez pas encore d\'amis</p>';
					}
				})
				.catch(error => {
					console.error('Erreur:', error);
					friendsList.innerHTML = `<p>Erreur: ${error.message}</p>`;
				});
			}

			function addFriend(username) {// Récupérer le conteneur d'erreur
				errorMessageDiv.innerHTML = '';

				fetch('/api/friends/add/', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ username: username })
				})
				.then(response => {
					if (!response.ok) {
						if (response.status === 401) {
							throw new Error('Non authentifié - veuillez vous reconnecter');
						}
						if (response.status === 404) {
							throw new Error('Utilisateur non trouvé');
						}
						if (response.status === 400) {
							throw new Error('Cet utilisateur est déjà votre ami ou vous ne pouvez pas vous ajouter vous-même');
						}
						throw new Error('Erreur lors de l\'ajout de l\'ami');
					}
					return response.json();
				})
				.then(data => {
					console.log('Ami ajouté avec succès:', data);
					fetchFriends(); // Rafraîchir la liste des amis
					errorMessageDiv.innerHTML = '<span style="color: green;">Ami ajouté avec succès !</span>'; // Message de succès (optionnel)
					setTimeout(() => errorMessageDiv.innerHTML = '', 3000); // Effacer après 3 secondes (optionnel)
				})
				.catch(error => {
					console.error('Erreur:', error);
					// Afficher l'erreur sous l'input au lieu de remplacer la liste des amis
					errorMessageDiv.innerHTML = `<span style="color: red;">${error.message}</span>`;
					setTimeout(() => errorMessageDiv.innerHTML = '', 5000); // Effacer après 5 secondes (optionnel)
				});
			}
		});
	</script>

	<script type="importmap">
		{
			"imports": {
				"three": "https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.module.js",
				"three/addons/": "https://cdn.jsdelivr.net/npm/three@0.152.0/examples/jsm/"
			}
		}
	</script>

	<script src="{% static 'js/gameInvitations.js' %}"></script>
	<style>
		@font-face {
			font-family: 'PPNeueMontreal';
			src: url('{% static "fonts/PPNeueMontreal-Book.otf" %}') format('truetype');
		}
	</style>
</header>
{% endblock %}
